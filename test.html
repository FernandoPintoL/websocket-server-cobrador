<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test WebSocket - Cobrador</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .connected {
            background: #d4edda;
            color: #155724;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        input,
        select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #messages {
            height: 300px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
</head>

<body>
<h1>üîå Test WebSocket - Cobrador</h1>

<div class="container">
    <h3>Configuraci√≥n del Servidor</h3>
    <label for="customServerUrl"><strong>URL del Servidor WebSocket:</strong></label>
    <input type="text" id="customServerUrl" placeholder="http://192.168.5.46:3001"
           value="http://192.168.5.46:3001" style="width: 300px;">
    <button onclick="reconnectWithCustomUrl()">Conectar</button>
    <p style="font-size: 12px; color: #666; margin-top: 5px;">
        Desde otra PC o celular: Usa la IP del servidor en tu red local (ej: http://192.168.5.46:3001)
    </p>
</div>

<div class="container">
    <h3>Informaci√≥n de Conexi√≥n</h3>
    <p><strong>URL Conectada:</strong> <span id="serverUrl">No conectado</span></p>
    <p><strong>Protocolo:</strong> <span id="protocol">-</span></p>
    <p><strong>Entorno:</strong> <span id="environment">-</span></p>
    <p><strong>Socket ID:</strong> <span id="socketId">-</span></p>
    <p><strong>Mi IP (vista por servidor):</strong> <span id="clientIP">-</span></p>
</div>

<div class="container">
    <h3>Estado de Conexi√≥n</h3>
    <div id="status" class="status disconnected">Desconectado</div>

    <h3>Autenticaci√≥n</h3>
    <input type="text" id="userId" placeholder="ID de Usuario" value="123">
    <select id="userType">
        <option value="client">Cliente</option>
        <option value="cobrador">Cobrador</option>
        <option value="manager">Manager</option>
        <option value="admin">Admin</option>
    </select>
    <input type="text" id="userName" placeholder="Nombre de Usuario" value="Usuario Test">
    <button onclick="authenticate()">Autenticar</button>
    <button onclick="disconnect()">Desconectar</button>
</div>

<div class="container">
    <h3>Enviar Notificaci√≥n de Cr√©dito</h3>
    <input type="text" id="targetUserId" placeholder="ID Usuario Destino" value="456">
    <input type="text" id="notificationTitle" placeholder="T√≠tulo" value="Nuevo Cr√©dito">
    <input type="text" id="notificationMessage" placeholder="Mensaje" value="Se ha asignado un nuevo cr√©dito">
    <button onclick="sendCreditNotification()">Enviar</button>
</div>

<div class="container">
    <h3>Actualizar Ubicaci√≥n (Solo Cobradores)</h3>
    <input type="number" id="latitude" placeholder="Latitud" value="-17.783327" step="any">
    <input type="number" id="longitude" placeholder="Longitud" value="-63.182140" step="any">
    <button onclick="updateLocation()">Actualizar Ubicaci√≥n</button>
</div>

<div class="container">
    <h3>Enviar Mensaje</h3>
    <input type="text" id="recipientId" placeholder="ID Destinatario" value="789">
    <input type="text" id="messageText" placeholder="Mensaje" value="Hola, este es un mensaje de prueba">
    <button onclick="sendMessage()">Enviar Mensaje</button>
</div>

<div class="container">
    <h3>Mensajes Recibidos</h3>
    <div id="messages"></div>
    <button onclick="clearMessages()">Limpiar</button>
</div>

<script>
    let socket = null;
    let currentUserId = null;
    let currentServerUrl = 'http://192.168.5.46:3001'; // Cambia esto seg√∫n tu IP en .env

    // Conectar con URL personalizada
    function reconnectWithCustomUrl() {
        const customUrl = document.getElementById('customServerUrl').value.trim();
        if (!customUrl) {
            addMessage('‚ùå Por favor ingresa una URL v√°lida', 'error');
            return;
        }

        // Validar que la URL sea v√°lida
        try {
            new URL(customUrl);
        } catch (e) {
            addMessage('‚ùå URL inv√°lida. Formato: http://IP:PUERTO', 'error');
            return;
        }

        // Desconectar si ya hay una conexi√≥n
        if (socket) {
            socket.disconnect();
            socket = null;
        }

        currentServerUrl = customUrl;

        // Cargar Socket.IO din√°micamente desde el servidor
        loadSocketIO(customUrl, () => {
            connectSocket(customUrl);
        });
    }

    // Cargar la librer√≠a Socket.IO desde el servidor
    function loadSocketIO(serverUrl, callback) {
        // Verificar si ya est√° cargado
        if (typeof io !== 'undefined') {
            callback();
            return;
        }

        addMessage('üì¶ Cargando librer√≠a Socket.IO desde el servidor...', 'info');

        const script = document.createElement('script');
        script.src = `${serverUrl}/socket.io/socket.io.js`;
        script.onload = () => {
            addMessage('‚úÖ Librer√≠a Socket.IO cargada correctamente', 'info');
            callback();
        };
        script.onerror = () => {
            addMessage('‚ùå Error al cargar Socket.IO. Verifica que el servidor est√© corriendo.', 'error');
            addMessage('üí° Aseg√∫rate de que puedes acceder a: ' + serverUrl, 'error');
        };
        document.head.appendChild(script);
    }

    function updateServerInfo(serverUrl) {
        const isSecure = serverUrl && serverUrl.startsWith('https');
        document.getElementById('serverUrl').textContent = serverUrl || 'No conectado';
        document.getElementById('protocol').textContent = isSecure ? 'HTTPS/WSS (Seguro)' : 'HTTP/WS (Desarrollo)';
        document.getElementById('environment').textContent = isSecure ? 'Producci√≥n' : 'Desarrollo';
    }

    // Conectar al servidor WebSocket
    function connectSocket(serverUrl) {
        if (!serverUrl) {
            serverUrl = currentServerUrl;
        }

        console.log(`üîå Conectando a: ${serverUrl}`);
        addMessage(`üîå Intentando conectar a: ${serverUrl}`, 'info');

        socket = io(serverUrl, {
            transports: ['websocket', 'polling'],
            upgrade: true,
            rememberUpgrade: true
        });

        socket.on('connect', () => {
            updateStatus('Conectado', 'connected');
            updateServerInfo(serverUrl);
            addMessage('‚úÖ Conectado al servidor WebSocket', 'info');
            document.getElementById('socketId').textContent = socket.id;
        });

        socket.on('disconnect', () => {
            updateStatus('Desconectado', 'disconnected');
            addMessage('‚ùå Desconectado del servidor', 'info');
            document.getElementById('socketId').textContent = '-';
            document.getElementById('clientIP').textContent = '-';
        });

        socket.on('connect_error', (error) => {
            updateStatus('Error de Conexi√≥n', 'disconnected');
            addMessage(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            console.error('Error de conexi√≥n:', error);
        });

        socket.on('authenticated', (data) => {
            addMessage(`‚úÖ Autenticado: ${data.message}`, 'info');
            if (data.clientIP) {
                document.getElementById('clientIP').textContent = data.clientIP;
                addMessage(`üìç Tu IP vista por el servidor: ${data.clientIP}`, 'info');
            }
        });

        socket.on('authentication_error', (data) => {
            addMessage(`‚ùå Error de autenticaci√≥n: ${data.message}`, 'error');
        });

        socket.on('new_credit_notification', (notification) => {
            addMessage(`üí∞ Nueva notificaci√≥n de cr√©dito: ${notification.title} - ${notification.message}`, 'notification');
        });
        socket.on('credit_lifecycle_update', (data) => {
            addMessage(`üè¶ Actualizaci√≥n de cr√©dito (${data.action}): ${JSON.stringify(data)}`, 'notification');
        });
        socket.on('credit_pending_approval', (data) => {
            addMessage(`‚è≥ Cr√©dito pendiente de aprobaci√≥n: ${JSON.stringify(data)}`, 'notification');
        });
        socket.on('credit_decision', (data) => {
            addMessage(`‚öñÔ∏è Decisi√≥n de cr√©dito (${data.action}): ${JSON.stringify(data)}`, 'notification');
        });
        socket.on('credit_delivered_notification', (data) => {
            addMessage(`üöö Cr√©dito entregado: ${JSON.stringify(data)}`, 'notification');
        });
        socket.on('credit_approved', (data) => {
            addMessage(`‚úÖ Cr√©dito aprobado (evento dedicado): ${JSON.stringify(data)}`,'notification');
        });
        socket.on('credit_attention_required', (data) => {
            addMessage(`üîî Cr√©dito requiere atenci√≥n: ${JSON.stringify(data)}`, 'notification');
        });

        socket.on('payment_updated', (payment) => {
            addMessage(`üí≥ Pago actualizado: ${JSON.stringify(payment)}`, 'notification');
        });
        socket.on('payment_received', (payment) => {
            addMessage(`üí≥ Pago recibido: ${JSON.stringify(payment)}`, 'notification');
        });
        socket.on('cobrador_payment_received', (payment) => {
            addMessage(`üì• Pago de cobrador recibido: ${JSON.stringify(payment)}`, 'notification');
        });

        socket.on('route_updated', (route) => {
            addMessage(`üó∫Ô∏è Ruta actualizada: ${JSON.stringify(route)}`, 'notification');
        });

        socket.on('new_message', (data) => {
            addMessage(`üí¨ Mensaje de ${data.senderId}: ${data.message}`, 'message');
        });

        socket.on('cobrador_location_update', (data) => {
            addMessage(`üìç Ubicaci√≥n de ${data.cobradorName}: ${data.latitude}, ${data.longitude}`, 'location');
        });

        socket.on('user_connected', (data) => {
            const ipInfo = data.clientIP ? ` - IP: ${data.clientIP}` : '';
            addMessage(`üëã Usuario conectado: ${data.userName} (${data.userType})${ipInfo}`, 'info');
        });

        socket.on('user_disconnected', (data) => {
            const ipInfo = data.clientIP ? ` - IP: ${data.clientIP}` : '';
            addMessage(`üëã Usuario desconectado: ${data.userName} (${data.userType})${ipInfo}`, 'info');
        });

        // Mostrar logs del servidor (console logs reenviados)
        socket.on('server_log', (text) => {
            addMessage(text, 'info');
        });
    }

    function authenticate() {
        if (!socket) {
            addMessage('‚ùå No hay conexi√≥n WebSocket', 'error');
            return;
        }

        const userId = document.getElementById('userId').value;
        const userType = document.getElementById('userType').value;
        const userName = document.getElementById('userName').value;

        if (!userId || !userName) {
            addMessage('‚ùå Complete todos los campos', 'error');
            return;
        }

        currentUserId = userId;
        socket.emit('authenticate', { userId, userType, userName });
    }

    function disconnect() {
        if (socket) {
            socket.disconnect();
            socket = null;
            currentUserId = null;
            updateStatus('Desconectado', 'disconnected');
        }
    }

    function sendCreditNotification() {
        if (!socket || !currentUserId) {
            addMessage('‚ùå Debe estar conectado y autenticado', 'error');
            return;
        }

        const targetUserId = document.getElementById('targetUserId').value;
        const title = document.getElementById('notificationTitle').value;
        const message = document.getElementById('notificationMessage').value;

        socket.emit('credit_notification', {
            targetUserId,
            notification: { title, message, type: 'credit' }
        });

        addMessage(`üì§ Notificaci√≥n enviada a usuario ${targetUserId}`, 'info');
    }

    function updateLocation() {
        if (!socket || !currentUserId) {
            addMessage('‚ùå Debe estar conectado y autenticado', 'error');
            return;
        }

        const latitude = parseFloat(document.getElementById('latitude').value);
        const longitude = parseFloat(document.getElementById('longitude').value);

        if (isNaN(latitude) || isNaN(longitude)) {
            addMessage('‚ùå Coordenadas inv√°lidas', 'error');
            return;
        }

        socket.emit('location_update', { latitude, longitude });
        addMessage(`üìç Ubicaci√≥n actualizada: ${latitude}, ${longitude}`, 'info');
    }

    function sendMessage() {
        if (!socket || !currentUserId) {
            addMessage('‚ùå Debe estar conectado y autenticado', 'error');
            return;
        }

        const recipientId = document.getElementById('recipientId').value;
        const message = document.getElementById('messageText').value;

        if (!recipientId || !message) {
            addMessage('‚ùå Complete todos los campos', 'error');
            return;
        }

        socket.emit('send_message', {
            recipientId,
            message,
            senderId: currentUserId
        });

        addMessage(`üì§ Mensaje enviado a usuario ${recipientId}`, 'info');
    }

    function updateStatus(text, className) {
        const statusElement = document.getElementById('status');
        statusElement.textContent = text;
        statusElement.className = `status ${className}`;
    }

    function addMessage(message, type = 'info') {
        const messagesDiv = document.getElementById('messages');
        const timestamp = new Date().toLocaleTimeString();
        const messageElement = document.createElement('div');
        messageElement.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
        messageElement.style.marginBottom = '5px';

        if (type === 'error') messageElement.style.color = '#dc3545';
        else if (type === 'notification') messageElement.style.color = '#28a745';
        else if (type === 'message') messageElement.style.color = '#007bff';
        else if (type === 'location') messageElement.style.color = '#ffc107';

        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function clearMessages() {
        document.getElementById('messages').innerHTML = '';
    }

    // Inicializar al cargar la p√°gina
    window.onload = function () {
        updateServerInfo(null);
        addMessage('üöÄ P√°gina cargada. Haz clic en "Conectar" para establecer la conexi√≥n', 'info');
        addMessage('üí° Servidor configurado: ' + currentServerUrl, 'info');
        addMessage('üì± Para celulares: Aseg√∫rate de estar en la misma red WiFi', 'info');
    };
</script>
</body>

</html>
