<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test WebSocket - Cobrador</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .connected {
            background: #d4edda;
            color: #155724;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        input,
        select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #messages {
            height: 300px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <h1>üîå Test WebSocket - Cobrador</h1>

    <div class="container">
        <h3>Estado de Conexi√≥n</h3>
        <div id="status" class="status disconnected">Desconectado</div>

        <h3>Autenticaci√≥n</h3>
        <input type="text" id="userId" placeholder="ID de Usuario" value="123">
        <select id="userType">
            <option value="client">Cliente</option>
            <option value="cobrador">Cobrador</option>
            <option value="admin">Admin</option>
        </select>
        <input type="text" id="userName" placeholder="Nombre de Usuario" value="Usuario Test">
        <button onclick="authenticate()">Autenticar</button>
        <button onclick="disconnect()">Desconectar</button>
    </div>

    <div class="container">
        <h3>Enviar Notificaci√≥n de Cr√©dito</h3>
        <input type="text" id="targetUserId" placeholder="ID Usuario Destino" value="456">
        <input type="text" id="notificationTitle" placeholder="T√≠tulo" value="Nuevo Cr√©dito">
        <input type="text" id="notificationMessage" placeholder="Mensaje" value="Se ha asignado un nuevo cr√©dito">
        <button onclick="sendCreditNotification()">Enviar</button>
    </div>

    <div class="container">
        <h3>Actualizar Ubicaci√≥n (Solo Cobradores)</h3>
        <input type="number" id="latitude" placeholder="Latitud" value="-17.783327" step="any">
        <input type="number" id="longitude" placeholder="Longitud" value="-63.182140" step="any">
        <button onclick="updateLocation()">Actualizar Ubicaci√≥n</button>
    </div>

    <div class="container">
        <h3>Enviar Mensaje</h3>
        <input type="text" id="recipientId" placeholder="ID Destinatario" value="789">
        <input type="text" id="messageText" placeholder="Mensaje" value="Hola, este es un mensaje de prueba">
        <button onclick="sendMessage()">Enviar Mensaje</button>
    </div>

    <div class="container">
        <h3>Mensajes Recibidos</h3>
        <div id="messages"></div>
        <button onclick="clearMessages()">Limpiar</button>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        let socket = null;
        let currentUserId = null;

        // Conectar al servidor WebSocket
        function connectSocket() {
            socket = io('http://localhost:3001');

            socket.on('connect', () => {
                updateStatus('Conectado', 'connected');
                addMessage('‚úÖ Conectado al servidor WebSocket', 'info');
            });

            socket.on('disconnect', () => {
                updateStatus('Desconectado', 'disconnected');
                addMessage('‚ùå Desconectado del servidor', 'info');
            });

            socket.on('authenticated', (data) => {
                addMessage(`‚úÖ Autenticado: ${data.message}`, 'info');
            });

            socket.on('authentication_error', (data) => {
                addMessage(`‚ùå Error de autenticaci√≥n: ${data.message}`, 'error');
            });

            socket.on('new_credit_notification', (notification) => {
                addMessage(`üí∞ Nueva notificaci√≥n de cr√©dito: ${notification.title} - ${notification.message}`, 'notification');
            });

            socket.on('payment_updated', (payment) => {
                addMessage(`üí≥ Pago actualizado: ${JSON.stringify(payment)}`, 'notification');
            });

            socket.on('route_updated', (route) => {
                addMessage(`üó∫Ô∏è Ruta actualizada: ${JSON.stringify(route)}`, 'notification');
            });

            socket.on('new_message', (data) => {
                addMessage(`üí¨ Mensaje de ${data.senderId}: ${data.message}`, 'message');
            });

            socket.on('cobrador_location_update', (data) => {
                addMessage(`üìç Ubicaci√≥n de ${data.cobradorName}: ${data.latitude}, ${data.longitude}`, 'location');
            });

            socket.on('user_connected', (data) => {
                addMessage(`üëã Usuario conectado: ${data.userName} (${data.userType})`, 'info');
            });

            socket.on('user_disconnected', (data) => {
                addMessage(`üëã Usuario desconectado: ${data.userName} (${data.userType})`, 'info');
            });
        }

        function authenticate() {
            if (!socket) {
                addMessage('‚ùå No hay conexi√≥n WebSocket', 'error');
                return;
            }

            const userId = document.getElementById('userId').value;
            const userType = document.getElementById('userType').value;
            const userName = document.getElementById('userName').value;

            if (!userId || !userName) {
                addMessage('‚ùå Complete todos los campos', 'error');
                return;
            }

            currentUserId = userId;
            socket.emit('authenticate', { userId, userType, userName });
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                currentUserId = null;
                updateStatus('Desconectado', 'disconnected');
            }
        }

        function sendCreditNotification() {
            if (!socket || !currentUserId) {
                addMessage('‚ùå Debe estar conectado y autenticado', 'error');
                return;
            }

            const targetUserId = document.getElementById('targetUserId').value;
            const title = document.getElementById('notificationTitle').value;
            const message = document.getElementById('notificationMessage').value;

            socket.emit('credit_notification', {
                targetUserId,
                notification: { title, message, type: 'credit' }
            });

            addMessage(`üì§ Notificaci√≥n enviada a usuario ${targetUserId}`, 'info');
        }

        function updateLocation() {
            if (!socket || !currentUserId) {
                addMessage('‚ùå Debe estar conectado y autenticado', 'error');
                return;
            }

            const latitude = parseFloat(document.getElementById('latitude').value);
            const longitude = parseFloat(document.getElementById('longitude').value);

            if (isNaN(latitude) || isNaN(longitude)) {
                addMessage('‚ùå Coordenadas inv√°lidas', 'error');
                return;
            }

            socket.emit('location_update', { latitude, longitude });
            addMessage(`üìç Ubicaci√≥n actualizada: ${latitude}, ${longitude}`, 'info');
        }

        function sendMessage() {
            if (!socket || !currentUserId) {
                addMessage('‚ùå Debe estar conectado y autenticado', 'error');
                return;
            }

            const recipientId = document.getElementById('recipientId').value;
            const message = document.getElementById('messageText').value;

            if (!recipientId || !message) {
                addMessage('‚ùå Complete todos los campos', 'error');
                return;
            }

            socket.emit('send_message', {
                recipientId,
                message,
                senderId: currentUserId
            });

            addMessage(`üì§ Mensaje enviado a usuario ${recipientId}`, 'info');
        }

        function updateStatus(text, className) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = text;
            statusElement.className = `status ${className}`;
        }

        function addMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const timestamp = new Date().toLocaleTimeString();
            const messageElement = document.createElement('div');
            messageElement.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            messageElement.style.marginBottom = '5px';

            if (type === 'error') messageElement.style.color = '#dc3545';
            else if (type === 'notification') messageElement.style.color = '#28a745';
            else if (type === 'message') messageElement.style.color = '#007bff';
            else if (type === 'location') messageElement.style.color = '#ffc107';

            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        // Conectar autom√°ticamente al cargar la p√°gina
        window.onload = function () {
            connectSocket();
            addMessage('üöÄ P√°gina cargada. Conectando...', 'info');
        };
    </script>
</body>

</html>