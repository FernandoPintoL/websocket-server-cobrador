<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test WebSocket - Conectividad Externa</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border-color: #28a745;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffc107;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-color: #17a2b8;
        }
        .input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.success {
            background-color: #28a745;
        }
        button.success:hover {
            background-color: #218838;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover {
            background-color: #c82333;
        }
        #log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            font-size: 12px;
            line-height: 1.4;
        }
        .highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test WebSocket - Conectividad desde otra PC</h1>

        <div class="error status">
            <strong>‚ö†Ô∏è PROBLEMA DETECTADO:</strong><br>
            El cliente est√° intentando conectarse a <code>localhost:3001</code> desde otra PC.<br>
            <strong>localhost</strong> en otra PC se refiere a esa PC, no a tu servidor.<br>
            <strong>Debes usar la IP del servidor: <code>192.168.1.23</code></strong>
        </div>

        <div class="input-group">
            <label for="serverUrl">üåê URL del servidor WebSocket:</label>
            <input type="text" id="serverUrl" value="http://192.168.1.23:3001" placeholder="http://IP-DEL-SERVIDOR:PUERTO">
            <small style="color: #666; margin-top: 5px; display: block;">
                ‚úÖ Correcto: http://192.168.1.23:3001 (IP del servidor)<br>
                ‚ùå Incorrecto: http://localhost:3001 (solo funciona en la misma PC)
            </small>
        </div>

        <div style="margin: 20px 0;">
            <button onclick="testConnection()">üîå Conectar WebSocket</button>
            <button onclick="testHttp()">üåê Test HTTP</button>
            <button onclick="testFirewall()">üî• Test Firewall</button>
            <button onclick="clearLog()" class="danger">üóëÔ∏è Limpiar Log</button>
        </div>

        <div id="status" class="info status">
            Estado: Listo para probar - Aseg√∫rate de usar la IP del servidor (no localhost)
        </div>

        <div>
            <h3>üìä Log de Conexi√≥n:</h3>
            <div id="log"></div>
        </div>

        <div class="info status" style="margin-top: 20px;">
            <h4>üîß Pasos de Soluci√≥n:</h4>
            <ol>
                <li><strong>Cambiar localhost por la IP del servidor:</strong> 192.168.1.23</li>
                <li><strong>Abrir puerto en firewall del servidor:</strong> Puerto 3001</li>
                <li><strong>Verificar conectividad:</strong> Usar este cliente de prueba</li>
            </ol>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        let socket = null;
        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            statusDiv.textContent = `Estado: ${message}`;
            statusDiv.className = `${type} status`;
        }

        function testConnection() {
            const url = document.getElementById('serverUrl').value.trim();

            // Validar URL
            if (url.includes('localhost')) {
                log('‚ùå ERROR: Est√°s usando localhost desde otra PC!', 'error');
                log('üîß SOLUCI√ìN: Cambia localhost por la IP del servidor: 192.168.1.23', 'warning');
                updateStatus('Error: localhost no funciona desde otra PC', 'error');
                return;
            }

            log(`üîå Intentando conectar a: ${url}`, 'info');
            updateStatus('Conectando...', 'warning');

            if (socket) {
                socket.disconnect();
                socket = null;
            }

            try {
                socket = io(url, {
                    transports: ['websocket', 'polling'],
                    timeout: 10000,
                    forceNew: true,
                    autoConnect: true
                });

                socket.on('connect', () => {
                    log('‚úÖ ¬°Conexi√≥n WebSocket exitosa!', 'success');
                    log(`‚úÖ Conectado con ID: ${socket.id}`, 'success');
                    updateStatus('Conectado exitosamente', 'success');

                    // Enviar mensaje de prueba
                    setTimeout(() => {
                        log('üß™ Enviando mensaje de prueba...', 'info');
                        socket.emit('test-message', {
                            message: 'Hola desde cliente externo',
                            timestamp: new Date().toISOString(),
                            clientIP: 'externa'
                        });
                    }, 1000);
                });

                socket.on('disconnect', (reason) => {
                    log(`‚ùå Desconectado: ${reason}`, 'error');
                    updateStatus('Desconectado', 'error');
                });

                socket.on('connect_error', (error) => {
                    log(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                    updateStatus('Error de conexi√≥n', 'error');

                    // Diagn√≥stico espec√≠fico
                    if (error.message.includes('ECONNREFUSED')) {
                        log('üîç DIAGN√ìSTICO: El servidor no responde en ese puerto', 'warning');
                        log('   ‚Ä¢ ¬øEst√° corriendo el servidor WebSocket?', 'warning');
                        log('   ‚Ä¢ ¬øEst√° bloqueado por firewall?', 'warning');
                        log('   ‚Ä¢ ¬øEs la IP correcta?', 'warning');
                    } else if (error.message.includes('timeout')) {
                        log('üîç DIAGN√ìSTICO: Timeout - posible firewall', 'warning');
                        log('   ‚Ä¢ El servidor no respondi√≥ en 10 segundos', 'warning');
                        log('   ‚Ä¢ Probablemente firewall bloqueando puerto 3001', 'warning');
                    } else if (error.message.includes('network')) {
                        log('üîç DIAGN√ìSTICO: Problema de red', 'warning');
                        log('   ‚Ä¢ ¬øAmbas PCs est√°n en la misma red?', 'warning');
                        log('   ‚Ä¢ ¬øLa IP es accesible?', 'warning');
                    }
                });

                socket.on('test-response', (data) => {
                    log(`‚úÖ Respuesta del servidor: ${JSON.stringify(data)}`, 'success');
                });

                // Timeout manual adicional
                setTimeout(() => {
                    if (socket && !socket.connected) {
                        log('‚è∞ Timeout: No se pudo conectar en 15 segundos', 'error');
                        socket.disconnect();
                    }
                }, 15000);

            } catch (error) {
                log(`‚ùå Error al crear conexi√≥n: ${error.message}`, 'error');
                updateStatus('Error', 'error');
            }
        }

        async function testHttp() {
            const url = document.getElementById('serverUrl').value.trim();

            if (url.includes('localhost')) {
                log('‚ùå ERROR: No uses localhost desde otra PC!', 'error');
                return;
            }

            log(`üåê Probando conectividad HTTP a: ${url}`, 'info');

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const response = await fetch(url, {
                    signal: controller.signal,
                    mode: 'cors'
                });

                clearTimeout(timeoutId);

                if (response.ok) {
                    log('‚úÖ Servidor HTTP responde correctamente', 'success');
                    log(`   Status: ${response.status} ${response.statusText}`, 'success');
                    log('‚úÖ El puerto est√° abierto y accesible', 'success');
                } else {
                    log(`‚ö†Ô∏è Servidor responde con status: ${response.status}`, 'warning');
                }
            } catch (error) {
                log(`‚ùå Error HTTP: ${error.message}`, 'error');

                if (error.name === 'AbortError') {
                    log('üîç DIAGN√ìSTICO: Timeout - posible firewall', 'warning');
                } else if (error.message.includes('Failed to fetch')) {
                    log('üîç DIAGN√ìSTICO: No se puede alcanzar el servidor', 'warning');
                    log('   ‚Ä¢ ¬øEst√° corriendo el servidor?', 'warning');
                    log('   ‚Ä¢ ¬øFirewall bloquea el puerto 3001?', 'warning');
                    log('   ‚Ä¢ ¬øIP correcta? (usa 192.168.1.23)', 'warning');
                }
            }
        }

        async function testFirewall() {
            const url = document.getElementById('serverUrl').value.trim();
            const match = url.match(/http:\/\/([^:]+):(\d+)/);

            if (!match) {
                log('‚ùå URL inv√°lida para test de firewall', 'error');
                return;
            }

            const [, ip, port] = match;
            log(`üî• Probando conectividad al puerto ${port} en ${ip}...`, 'info');

            try {
                // Crear un WebSocket de prueba directa
                const ws = new WebSocket(`ws://${ip}:${port}/socket.io/?EIO=4&transport=websocket`);

                const timeout = setTimeout(() => {
                    ws.close();
                    log('‚è∞ Timeout: Firewall probablemente bloqueando puerto', 'error');
                    log('üîß SOLUCI√ìN: Abrir puerto en firewall del servidor:', 'warning');
                    log(`   netsh advfirewall firewall add rule name="WebSocket ${port}" dir=in action=allow protocol=TCP localport=${port}`, 'warning');
                }, 5000);

                ws.onopen = () => {
                    clearTimeout(timeout);
                    log('‚úÖ Puerto accesible - Firewall OK', 'success');
                    ws.close();
                };

                ws.onerror = (error) => {
                    clearTimeout(timeout);
                    log('‚ùå Error de WebSocket - posible firewall', 'error');
                };

            } catch (error) {
                log(`‚ùå Error en test de firewall: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            logDiv.textContent = '';
        }

        // Inicializaci√≥n
        log('üöÄ Cliente de prueba WebSocket iniciado', 'info');
        log('üí° IMPORTANTE: Cambia localhost por la IP del servidor (192.168.1.23)', 'warning');

        // Auto-detectar si se est√° usando localhost
        const urlInput = document.getElementById('serverUrl');
        urlInput.addEventListener('input', (e) => {
            if (e.target.value.includes('localhost')) {
                updateStatus('‚ö†Ô∏è localhost no funciona desde otra PC - usa la IP del servidor', 'warning');
            } else {
                updateStatus('Listo para probar', 'info');
            }
        });
    </script>
</body>
</html>

